---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: teslamate
  namespace: default
spec:
  interval: 1h0m0s
  chart:
    spec:
      chart: teslamate
      version: 7.1.2
      sourceRef:
        kind: HelmRepository
        name: k8s-at-home
        namespace: flux-system
      interval: 5m
  dependsOn:
    - name: yasr-volume
  values:
    image:
      repository: teslamate/teslamate
      pullPolicy: Always
      tag: 1.27.2
    env:
      TZ: "America/New_York"
      DATABASE_HOST: teslamate-postgresql
#      DATABASE_USER: teslamate
      DATABASE_USER: postgres # teslamate complains about not being able to run migrations, you have to use postgres the first time, then connect to postgress and add the priviledges to its migrations table, then revert this back to use teslamate.
      DATABASE_PASS: "${ADMIN_PASSWORD}"
      DISABLE_MQTT: "true"
      MQTT_HOST: "emqx"
      MQTT_USERNAME: "mqtt"
      ENCRYPTION_KEY: "CHANGE ME, SEE PAPERLESS OR BITWARDEN"
    postgresql:
      enabled: true
      auth:
        enablePostgresUser: true
        postgresPassword: "${ADMIN_PASSWORD}"
        username: teslamate
        password: "${ADMIN_PASSWORD}"
        database: teslamate
      primary:
        persistence:
          enabled: true
          existingClaim: yasr-volume
          mountPath: /bitnami/postgresql
          subPath: configs/teslamate/database
        podSecurityContext:
          enabled: true
          fsGroup: 1000
        containerSecurityContext:
          enabled: true
          runAsUser: 1000
    ingress:
      main:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: "nginx"
        hosts:
        - host: teslamate.${INGRESS_INTERNAL_NAME}
          paths:
          - path: /
            pathType: Prefix
        tls:
        - hosts:
          - teslamate.${INGRESS_INTERNAL_NAME}
#  valuesFrom:
#    - kind: Secret
#      name: teslamate-postgresql
#      optional: false
