---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: zigbee2mqtt
  namespace: kube-system
spec:
  interval: 1h0m0s
  url: https://charts.zigbee2mqtt.io
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: zigbee2mqtt
  namespace: default
spec:
  interval: 5m
  chart:
    spec:
      chart: zigbee2mqtt
      version: ""  # Use latest
      sourceRef:
        kind: HelmRepository
        name: zigbee2mqtt
        namespace: kube-system
      interval: 5m
  values:
    initContainer:
      image:
        repository: docker.io/mikefarah/yq
        tag: "4.45.1"
    statefulset:
      nodeSelector:
        node-role.kubernetes.io/control-plane: ""
      podLabels:
        goharbor.io/harbor-container-webhook-disable: "true"
      hostNetwork: true
      hostPID: true
      storage:
        enabled: false
      volumes:
      - name: persistent-data
        persistentVolumeClaim:
          claimName: yasr-volume
      volumeMounts:
      - name: persistent-data
        mountPath: /app/data
        subPath: configs/zigbee2mqtt
    container:
      securityContext:
        privileged: true
    env:
      TZ: "${CLUSTER_TIME_ZONE}"
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        forecastle.stakater.com/expose: "true"
        forecastle.stakater.com/icon: ""
      hosts:
      - host: zigbee.${CLUSTER_DOMAIN_NAME}
        paths:
        - path: /
          pathType: ImplementationSpecific
        - path: /api
          pathType: ImplementationSpecific
      tls:
      - hosts:
        - zigbee.${CLUSTER_DOMAIN_NAME}
        secretName: internal-ingress-cert
    zigbee2mqtt:
      serial:
        port: /dev/ttyUSB0
        adapter: ember
      mqtt:
        server: mqtt://mosquitto.default.svc.cluster.local:1883
