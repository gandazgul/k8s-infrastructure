---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: zigbee2mqtt
  namespace: kube-system
spec:
  interval: 1h0m0s
  url: https://charts.zigbee2mqtt.io
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: zigbee2mqtt
  namespace: default
spec:
  interval: 5m
  chart:
    spec:
      chart: zigbee2mqtt
      version: ""  # Use latest
      sourceRef:
        kind: HelmRepository
        name: zigbee2mqtt
        namespace: kube-system
      interval: 5m
  values:
    statefulset:
      nodeSelector:
        node-role.kubernetes.io/control-plane: ""
      storage:
        enabled: false
      volumes:
      - name: persistent-data
        persistentVolumeClaim:
          claimName: yasr-volume
      - name: usb-device
        hostPath:
          path: /dev/ttyACM0
      volumeMounts:
      - name: persistent-data
        mountPath: /app/data
        subPath: configs/zigbee2mqtt
      - name: usb-device
        mountPath: /dev/ttyACM0
    container:
      securityContext:
        privileged: true
    env:
      TZ: "${CLUSTER_TIME_ZONE}"
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        forecastle.stakater.com/expose: "true"
        forecastle.stakater.com/icon: ""
      hosts:
      - host: zigbee.${CLUSTER_DOMAIN_NAME}
        paths:
        - path: /
          pathType: ImplementationSpecific
        - path: /api
          pathType: ImplementationSpecific
      tls:
      - hosts:
        - zigbee.${CLUSTER_DOMAIN_NAME}
        secretName: internal-ingress-cert
    zigbee2mqtt:
      serial:
        port: /dev/ttyACM0
        adapter: ezsp
      mqtt:
        server: mqtt://mosquitto.default.svc.cluster.local:1883
