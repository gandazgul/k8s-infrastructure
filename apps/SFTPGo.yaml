---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: sftpgo
  namespace: default
spec:
  interval: 5m
  chart:
    spec:
      chart: sftpgo
      version: 0.12.0
      sourceRef:
        kind: HelmRepository
        name: skm
        namespace: flux-system
      interval: 5m
  dependsOn:
  - name: yasr-volume
  - name: main-volume
  values:
    env:
      TZ: "${CLUSTER_TIME_ZONE}"
    sftpd:
      enabled: true
    webdavd:
      enabled: true
    httpd:
      enabled: true
    config:
      data_provider:
        drive: 'sqlite'
        sqlite: 'db.sqlite'
        prefer_database_credentials: true
    volumes:
    - name: main-volume
      persistentVolumeClaim:
        claimName: main-volume
    - name: yasr-volume
      persistentVolumeClaim:
        claimName: yasr-volume
    volumeMounts:
    - mountPath: /data
      name: main-volume
    ui:
      ingress:
        enabled: true
        className: nginx
        hosts:
        - host: sftp.${INGRESS_INTERNAL_NAME}
          paths:
          - path: /
            pathType: ImplementationSpecific
        tls:
        - hosts:
          - sftp.${INGRESS_INTERNAL_NAME}
          secretName: internal-ingress-cert
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: sftpgo-webdav
  labels:
    app.kubernetes.io/name: sftpgo-webdav
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - webdav.${INGRESS_INTERNAL_NAME}
    secretName: internal-ingress-cert
  rules:
  - host: webdav.${INGRESS_INTERNAL_NAME}
    http:
      paths:
      - path: /
        pathType: ImplementationSpecific
        backend:
          service:
            name: sftpgo
            port:
              name: webdav
