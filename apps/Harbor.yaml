---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: HelmRepository
metadata:
  name: harbor
  namespace: kube-system
spec:
  interval: 1h0m0s
  url: "https://helm.goharbor.io"

---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: harbor
  namespace: default
spec:
  interval: 5m
  chart:
    spec:
      chart: harbor
      version: 1.16.2
      sourceRef:
        kind: HelmRepository
        name: harbor
        namespace: kube-system
      interval: 5m
  values:
    externalURL: https://harbor.${CLUSTER_DOMAIN_NAME}
    harborAdminPassword: ${ADMIN_PASSWORD}
    secretKey: ${PAPERLESS_SECRET_KEY}
    cache:
      enabled: true
      expireHours: 168
    expose:
      type: ingress
      tls:
        enabled: true
        certSource: secret
        secret:
          secretName: internal-ingress-cert
      ingress:
        hosts:
          core: harbor.${CLUSTER_DOMAIN_NAME}
        annotations:
          kubernetes.io/ingress.class: "nginx"
          forecastle.stakater.com/appName: "Harbor"
          forecastle.stakater.com/expose: "true"
          forecastle.stakater.com/icon: ""
    persistence:
      enabled: true
      persistentVolumeClaim:
        registry:
          existingClaim: yasr-volume
          subPath: configs/harbor/registry
        database:
          existingClaim: yasr-volume
          subPath: configs/harbor/database
        redis:
          existingClaim: yasr-volume
          subPath: configs/harbor/redis
        trivy:
          existingClaim: yasr-volume
          subPath: configs/harbor/trivy
    containerSecurityContext:
      fsGroup: 1000
      fsGroupChangePolicy: "OnRootMismatch"
---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: HelmRepository
metadata:
  name: harbor-container-webhook
  namespace: kube-system
spec:
  interval: 1h0m0s
  url: "https://indeedeng.github.io/harbor-container-webhook/"
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: harbor-container-webhook
  namespace: default
spec:
  interval: 5m
  chart:
    spec:
      chart: harbor-container-webhook
      version: 0.7.1
      sourceRef:
        kind: HelmRepository
        name: harbor-container-webhook
        namespace: kube-system
      interval: 5m
  values:
    image:
      pullPolicy: Always
    rules:
      - name: 'docker.io replace rule'
        matches:
          - '^docker.io\/'
        replace: 'mirror.gcr.io'
        checkUpstream: false
      - name: 'no repo replace rule'
        matches:
          - '^(([a-zA-Z0-9\-\.]+/)?([a-zA-Z0-9\-\.]+):([a-zA-Z0-9\-\.]+))$'
        replace: 'mirror.gcr.io/$1'
        checkUpstream: true
