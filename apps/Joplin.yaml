---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: joplin-server
  namespace: default
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://k8s-at-home.com/charts/
      chart: joplin-server
      version: 5.1.2
      sourceRef:
        kind: HelmRepository
        name: k8s-at-home
        namespace: flux-system
      interval: 5m
  dependsOn:
    - name: yasr-volume
  # All values at https://github.com/k8s-at-home/charts/blob/master/charts/plex/values.yaml
  values:
    image:
      repository: joplin/server
      tag: latest
      pullPolicy: Always
    env:
      PUID: "1000"
      PGID: "1000"
      TZ: "${CLUSTER_TIME_ZONE}"
      # -- joplin-server base URL
      APP_BASE_URL: https://joplin.${INGRESS_EXTERNAL_NAME}
      # -- joplin-server listening port (same as Service port)
      APP_PORT: 22300
      # -- Use pg for postgres
#      DB_CLIENT:  pg
#      POSTGRES_HOST:  joplin-postgresql
#      POSTGRES_PORT:  5432
#      POSTGRES_DATABASE:  joplin
#      POSTGRES_USER:  admin_joplin
#      POSTGRES_PASSWORD: ${ADMIN_PASSWORD}
    persistence:
      config:
        enabled: true
        mountPath: /joplin
        existingClaim: main-volume
        subPath: rafag/joplin
    ingress:
      main:
        enabled: true
        hosts:
          - host: joplin.${INGRESS_EXTERNAL_NAME}
            paths:
              - path: /
        tls:
          - hosts:
              - joplin.${INGRESS_EXTERNAL_NAME}
            secretName: internal-ingress-cert
        annotations:
          kubernetes.io/ingress.class: "nginx"
