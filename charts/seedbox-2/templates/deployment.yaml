apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "helpers.fullname" . }}
  labels:
    app: {{ include "helpers.name" . }}
    chart: {{ include "helpers.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: {{ include "helpers.name" . }}
      release: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app: {{ include "helpers.name" . }}
        release: {{ .Release.Name }}
    spec:
      {{- with .Values.volumes }}
      volumes:
  {{ toYaml . | nindent 6 }}
  {{- end}}
dnsPolicy: {{ .Values.dnsPolicy }}
dnsConfig:
  {{ toYaml .Values.dnsConfig | indent 8 }}
containers:
  - name: {{ .Values.transmission.name }}
    image: "{{ .Values.transmission.image.name }}:{{ .Values.transmission.image.tag }}"
    imagePullPolicy: {{ .Values.transmission.image.pullPolicy | quote }}
    {{- with .Values.transmission.env }}
    env:
  {{ toYaml . | nindent 12 }}
  {{- end}}
resources:
  limits:
    cpu: {{ default "50m" .Values.transmission.resources.limits.cpu | quote }}
    memory: {{ .Values.transmission.resources.limits.memory | default "50Mi" | quote }}
  requests:
    cpu: {{ default "50m" .Values.transmission.resources.requests.cpu | quote }}
    memory: {{ default "50Mi" .Values.transmission.resources.requests.memory | quote }}
volumeMounts:
  {{ toYaml .Values.transmission.volumeMounts | indent 12 }}
ports:
  - name: http
    containerPort: 9091
    protocol: TCP
- name: {{ .Values.vpn.name | quote }}
  image: "{{ .Values.vpn.image.name }}:{{ .Values.vpn.image.tag }}"
  imagePullPolicy: {{ .Values.vpn.image.pullPolicy | quote }}
  {{- with .Values.vpn.env }}
  env:
  {{ toYaml . | nindent 12 }}
  {{- end}}
securityContext:
  capabilities:
    add: ["NET_ADMIN"]
resources:
  limits:
    cpu: {{ default "50m" .Values.vpn.resources.limits.cpu | quote }}
    memory: {{ default "50Mi" .Values.vpn.resources.limits.memory | quote }}
  requests:
    cpu: {{ default "50m" .Values.vpn.resources.requests.cpu | quote }}
    memory: {{ default "50Mi" .Values.vpn.resources.requests.memory | quote }}
volumeMounts:
  {{ toYaml .Values.vpn.volumeMounts | indent 12 }}
- name: {{ .Values.flexget.name | quote }}
  image: "{{ .Values.flexget.image.name }}:{{ .Values.flexget.image.tag }}"
  imagePullPolicy: {{ .Values.flexget.image.pullPolicy | quote }}
  {{- with .Values.flexget.env }}
env:
  {{ toYaml . | nindent 12 }}
  {{- end}}
resources:
  limits:
    cpu: {{ default "50m" .Values.flexget.resources.limits.cpu | quote }}
    memory: {{ default "50Mi" .Values.flexget.resources.limits.memory | quote }}
  requests:
    cpu: {{ default "50m" .Values.flexget.resources.requests.cpu | quote }}
    memory: {{ default "50Mi" .Values.flexget.resources.requests.memory | quote }}
volumeMounts:
  {{ toYaml .Values.flexget.volumeMounts | indent 12 }}
ports:
  - name: flexget-http
    containerPort: 3539
    protocol: TCP
  {{- with .Values.nodeSelector }}
nodeSelector:
  {{ toYaml . | indent 8 }}
  {{- end }}
  {{- with .Values.affinity }}
affinity:
  {{ toYaml . | indent 8 }}
  {{- end }}
  {{- with .Values.tolerations }}
tolerations:
  {{ toYaml . | indent 8 }}
  {{- end }}
