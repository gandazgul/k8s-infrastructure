---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-dns01-prod
spec:
  acme:
    # The ACME server URL
    server: https://acme-v02.api.letsencrypt.org/directory
    # Email address used for ACME registration
    email: ${EMAIL}
    # Name of a secret used to store the ACME account private key
    privateKeySecretRef:
      name: letsencrypt-prod
    # Enable the HTTP-01 challenge provider
    solvers:
    # An empty 'selector' means that this solver matches all domains
    - selector: { }
      dns01:
        acmeDNS:
          accountSecretRef:
            name: auth-acme-dns-io-credentials
            key: acmedns.json
          host: https://auth.acme-dns.io
---
apiVersion: v1
kind: Secret
metadata:
  name: auth-acme-dns-io-credentials
  namespace: kube-system
stringData:
  acmedns.json: |
    {
      "${INGRESS_INTERNAL_NAME}": {
        "username": "${ACME_DNS_USERNAME}",
        "password": "${ACME_DNS_PASSWORD}",
        "fulldomain": "${ACME_DNS_SUBDOMAIN}.auth.acme-dns.io",
        "subdomain": "${ACME_DNS_SUBDOMAIN}",
        "allowfrom": []
      },
      "${INGRESS_EXTERNAL_NAME}": {
        "username": "${ACME_DNS_USERNAME}",
        "password": "${ACME_DNS_PASSWORD}",
        "fulldomain": "${ACME_DNS_SUBDOMAIN}.auth.acme-dns.io",
        "subdomain": "${ACME_DNS_SUBDOMAIN}",
        "allowfrom": []
      }
    }
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: internal-ingress-cert
  namespace: kube-system
spec:
  dnsNames:
  - "*.${INGRESS_INTERNAL_NAME}"
  - ${INGRESS_INTERNAL_NAME}
  issuerRef:
    group: cert-manager.io
    kind: ClusterIssuer
    name: letsencrypt-dns01-prod
  secretName: internal-ingress-cert
  usages:
  - digital signature
  - key encipherment
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: internal-dummy-ingress-to-load-certificates
  namespace: kube-system
spec:
  tls:
  - hosts:
    - "*.${INGRESS_INTERNAL_NAME}"
    secretName: internal-ingress-cert
  rules:
  - host: "*.${INGRESS_INTERNAL_NAME}"
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: external-ingress-cert
  namespace: kube-system
spec:
  dnsNames:
  - "*.${INGRESS_EXTERNAL_NAME}"
  - ${INGRESS_EXTERNAL_NAME}
  issuerRef:
    group: cert-manager.io
    kind: ClusterIssuer
    name: letsencrypt-dns01-prod
  secretName: external-ingress-cert
  usages:
  - digital signature
  - key encipherment
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: external-dummy-ingress-to-load-certificates
  namespace: kube-system
spec:
  tls:
  - hosts:
    - "*.${INGRESS_EXTERNAL_NAME}"
    secretName: external-ingress-cert
  rules:
  - host: "*.${INGRESS_EXTERNAL_NAME}"
---
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: internal-ingress-cert
  namespace: default
spec:
  dnsNames:
  - "*.${INGRESS_INTERNAL_NAME}"
  - ${INGRESS_INTERNAL_NAME}
  issuerRef:
    group: cert-manager.io
    kind: ClusterIssuer
    name: letsencrypt-dns01-prod
  secretName: internal-ingress-cert
  usages:
  - digital signature
  - key encipherment
