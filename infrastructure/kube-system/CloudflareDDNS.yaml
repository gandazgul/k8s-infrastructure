---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: cloudflare-ddns
  namespace: default
spec:
  interval: 1h0m0s
  path: ./infrastructure/cronjob/
  sourceRef:
    kind: GitRepository
    name: k8s-infrastructure
    namespace: kube-system
  prune: true
  targetNamespace: default
  postBuild:
    substitute:
      CRONJOB_NAME: cloudflare-ddns
      # Every hour
      SCHEDULE: "0 */1 * * *"
      IMAGE: docker.io/rafaelgil83/ddns-cloudflare:vaf00940
      NAMESPACE: default
  patches:
    - patch: |
        apiVersion: batch/v1
        kind: CronJob
        metadata:
          name: cloudflare-ddns
        spec:
          jobTemplate:
            spec:
              template:
                metadata:
                  labels:
                    goharbor.io/harbor-container-webhook-disable: "true"
                spec:
                  containers:
                    - name: cronjob
                      env:
                        - name: CLUSTER_NAME
                          value: ${CLUSTER_NAME}
                        - name: CLOUDFLARE_API_TOKEN
                          value: ${CLOUDFLARE_API_TOKEN}
                        - name: CLOUDFLARE_API_EMAIL
                          value: ${CLOUDFLARE_API_EMAIL}
                        - name: CLUSTER_DOMAIN_NAME
                          value: ${CLUSTER_DOMAIN_NAME}
                        - name: CLOUDFLARE_ZONE_ID
                          value: ${CLOUDFLARE_ZONE_ID}
      target:
        kind: CronJob
