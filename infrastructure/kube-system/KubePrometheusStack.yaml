apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: default
spec:
  chart:
    spec:
      chart: kube-prometheus-stack
      version: 50.2.0
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: kube-system
  interval: 1h0m0s
  values:
    alertmanager:
      ingress:
        enabled: true
        ingressClassName: nginx
        annotations:
          forecastle.stakater.com/appName: "Alertmanager"
          forecastle.stakater.com/group: "Management"
          forecastle.stakater.com/expose: "true"
        hosts:
        - alertmanager.${CLUSTER_DOMAIN_NAME}
        paths:
        - /
        pathType: ImplementationSpecific
        tls:
        - hosts:
          - alertmanager.${CLUSTER_DOMAIN_NAME}
          secretName: internal-ingress-cert
    grafana:
      adminPassword: ${ADMIN_PASSWORD}
      persistence:
        type: pvc
        enabled: true
        subPath: "configs/grafana"
        existingClaim: yasr-volume-kube-system
      ingress:
        enabled: true
        ingressClassName: nginx
        annotations:
          forecastle.stakater.com/appName: "Grafana"
          forecastle.stakater.com/group: "Management"
          forecastle.stakater.com/expose: "true"
          forecastle.stakater.com/icon: "https://grafana.${CLUSTER_DOMAIN_NAME}/public/img/grafana_icon.svg"
        hosts:
        - grafana.${CLUSTER_DOMAIN_NAME}
        paths:
        - /
        pathType: ImplementationSpecific
        tls:
        - hosts:
          - grafana.${CLUSTER_DOMAIN_NAME}
          secretName: internal-ingress-cert
      persistence:
        type: pvc
        enabled: true
        ## Sub-directory of the PV to mount. Can be templated.
        subPath: "configs/grafana"
        ## Name of an existing PVC. Can be templated.
        existingClaim: yasr-volume
      dashboardProviders:
          dashboardproviders.yaml:
            apiVersion: 1
            providers:
              - name: 'teslamate'
                orgId: 1
                folder: TeslaMate
                folderUid: Nr4ofiDZk
                type: file
                disableDeletion: false
                editable: true
                updateIntervalSeconds: 86400
                options:
                  path: /var/lib/grafana/dashboards/teslamate
              - name: 'teslamate_internal'
                orgId: 1
                folder: Internal
                folderUid: Nr5ofiDZk
                type: file
                disableDeletion: false
                editable: true
                updateIntervalSeconds: 86400
                options:
                  path: /var/lib/grafana/dashboards/teslamate_internal
              - name: 'teslamate_reports'
                orgId: 1
                folder: Reports
                folderUid: Nr6ofiDZk
                type: file
                disableDeletion: false
                editable: true
                updateIntervalSeconds: 86400
                options:
                  path: /var/lib/grafana/dashboards/teslamate_reports
      dashboards:
        teslamate:
          charges:
            file: charges.json

      additionalDataSources:
        - name: TeslaMate
          type: postgres
          url: teslamate-postgresql.default:5432
          user: teslamate
          database: teslamate
          password: "${ADMIN_PASSWORD}"
          access: proxy
          basicAuth: false
          withCredentials: false
          isDefault: false
          secureJsonData:
            password: "${ADMIN_PASSWORD}"
          jsonData:
            postgresVersion: 1000
            sslmode: disable
          version: 1
          editable: true

    prometheus:
      ingress:
        enabled: true
        ingressClassName: nginx
        annotations:
          forecastle.stakater.com/appName: "Prometheus"
          forecastle.stakater.com/group: "Management"
          forecastle.stakater.com/expose: "true"
          forecastle.stakater.com/icon: "https://upload.wikimedia.org/wikipedia/commons/3/38/Prometheus_software_logo.svg"
        hosts:
        - prometheus.${CLUSTER_DOMAIN_NAME}
        paths:
        - /
        pathType: ImplementationSpecific
        tls:
        - hosts:
          - prometheus.${CLUSTER_DOMAIN_NAME}
          secretName: internal-ingress-cert
