---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: incremental-backups
  namespace: kube-system
spec:
  interval: 1h0m0s
  path: ./infrastructure/cronjob/
  sourceRef:
    kind: GitRepository
    name: k8s-infrastructure
    namespace: kube-system
  prune: true
  targetNamespace: default
  postBuild:
    substitute:
      CRONJOB_NAME: incremental-backups
      SCHEDULE: "0 0,12 * * *"
      IMAGE_REPOSITORY: docker.io/gandazgul/rdiff-backup
      IMAGE_TAG: vfa41640
      NAMESPACE: default
  patches:
    - patch: |
        - op: add
          path: /spec/jobTemplate/spec/template/spec/volumes/-
          value:
            name: main-volume
            persistentVolumeClaim:
              claimName: main-volume
        - op: add
          path: /spec/jobTemplate/spec/template/spec/volumes/-
          value:
            name: backup-volume
            persistentVolumeClaim:
              claimName: backup-volume
      target:
        kind: CronJob
        name: incremental-backups
    - patch: |
        - op: add
          path: /spec/jobTemplate/spec/template/spec/containers/0/volumeMounts/-
          value:
            name: main-volume
            mountPath: /media/main
        - op: add
          path: /spec/jobTemplate/spec/template/spec/containers/0/volumeMounts/-
          value:
            name: backup-volume
            mountPath: /media/backup
      target:
        kind: CronJob
        name: incremental-backups
    - patch: |
        - op: replace
          path: /spec/jobTemplate/spec/template/spec/containers/0/args
          value: ["--force", "backup", "/media/main", "/media/backup"]
      target:
        kind: CronJob
        name: incremental-backups
  healthChecks:
    - apiVersion: batch/v1
      kind: Cronjob
      name: incremental-backups
      namespace: default
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: clean-incremental-backups
  namespace: kube-system
spec:
  interval: 1h0m0s
  path: ./infrastructure/cronjob/
  sourceRef:
    kind: GitRepository
    name: k8s-infrastructure
    namespace: kube-system
  prune: true
  targetNamespace: default
  postBuild:
    substitute:
      CRONJOB_NAME: clean-incremental-backups
      NAMESPACE: default
      SCHEDULE: "0 0 * * *"
      IMAGE_REPOSITORY: docker.io/gandazgul/rdiff-backup
      IMAGE_TAG: vfa41640
  patches:
    - patch: |
        - op: add
          path: /spec/jobTemplate/spec/template/spec/volumes/-
          value:
            name: backup-volume
            persistentVolumeClaim:
              claimName: backup-volume
      target:
        kind: CronJob
        name: clean-incremental-backups
    - patch: |
        - op: add
          path: /spec/jobTemplate/spec/template/spec/containers/0/volumeMounts/-
          value:
            name: backup-volume
            mountPath: /media/backup
      target:
        kind: CronJob
        name: clean-incremental-backups
    - patch: |
        - op: replace
          path: /spec/jobTemplate/spec/template/spec/containers/0/args
          value: ["remove", "increments", "--older-than", "4W", "/media/backup"]
      target:
        kind: CronJob
        name: clean-incremental-backups
  healthChecks:
    - apiVersion: batch/v1
      kind: Cronjob
      name: clean-incremental-backups
      namespace: default
