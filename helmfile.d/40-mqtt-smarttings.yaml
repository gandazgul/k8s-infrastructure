# MQTT and Smartthings related services ===========================================================

# NOTE: cli args take precedence over these
helmDefaults:
  wait: true
  timeout: 600
  #recreatePods: true
  force: true

releases:
  # MQTT Broker
  - name: mqtt-mosca
    namespace: default
    chart: ../charts/mosca
    values:
      - image:
          tag: "v2.8.3"
      - service:
          type: NodePort

  # This allows you to send MQTT messages to trigger commands in smartthings devices
  - name: smartthings-mqtt-bridge
    namespace: default
    chart: ../charts/smartthings-mqtt-bridge
    values:
      - image:
          tag: "v3.0.0"
      - service:
          port: 8081
      - volumes:
          - name: yasr-volume
            persistentVolumeClaim:
              claimName: yasr-volume
      - volumeMounts:
          - name: yasr-volume
            mountPath: "/config"
            subPath: "configs/smartthings-mqtt-bridge"

  # This is the same as the above but to bridge with the Nest API
#  - name: nest-mqtt-bridge
#    namespace: default
#    chart: ../charts/nest-mqtt-bridge
#    values:
#      - image:
#          tag: "vfdfc7cb"
#      - volumes:
#          - name: yasr-volume
#            persistentVolumeClaim:
#              claimName: yasr-volume
#      - volumeMounts:
#          - name: yasr-volume
#            mountPath: "/config"
#            subPath: "configs/nest-mqtt-bridge"

  - name: mqtt-node-red
    namespace: default
    chart: stable/node-red
    values:
      - timezone: America/New_York
      - persistence:
          enabled: true
          existingClaim: yasr-volume
          subPath: 'configs/node-red'
      - ingress:
          enabled: true
          hosts:
            - nodered.{{ requiredEnv "INGRESS_INTERNAL_NAME" }}
          tls:
            - hosts:
                - nodered.{{ requiredEnv "INGRESS_INTERNAL_NAME" }}
              secretName: nodered-k8s-cert
          annotations:
            kubernetes.io/ingress.class: "nginx"
            cert-manager.io/cluster-issuer: "ca-issuer"
