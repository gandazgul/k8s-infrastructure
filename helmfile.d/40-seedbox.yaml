# Seedbox ===========================================================
# Transmission and flexget running over an OpenVPN connection ;)

# NOTE: cli args take precedence over these
helmDefaults:
  wait: true
  timeout: 600
  #recreatePods: true
  force: true

releases:
  - name: seedbox
    namespace: services
    chart: ../charts/seedbox
    values:
      - image:
          tag: v2
      - env:
        - name: LOCAL_NETWORK
          value: "10.244.0.0/16"
        - name: OPENVPN_USERNAME
          value: {{ env "OPENVPN_USERNAME" | default "" }}
        - name: OPENVPN_PASSWORD
          value: {{ env "OPENVPN_PASSWORD" | default "" }}
        - name: TRANSMISSION_HOME
          value: "/data"
        - name: MAIL_TO
          value: {{ requiredEnv "MAIL_TO" }}
      - volumes:
        - name: yasr-volume
          persistentVolumeClaim:
            claimName: yasr-volume
        - name: main-volume
          persistentVolumeClaim:
            claimName: main-volume
        - name: dev-tun
          hostPath:
            path: "/dev/net/tun"
        - name: tz-config
          hostPath:
            path: /etc/localtime
      - volumeMounts:
        - name: main-volume
          mountPath: "/main"
        - name: yasr-volume
          mountPath: "/data"
          subPath: "transmission"
        - name: yasr-volume
          mountPath: "/config"
          subPath: "configs/"
        - name: dev-tun
          mountPath: "/dev/net/tun"
        - name: yasr-volume
          mountPath: "/etc/ssmtp/"
          subPath: "configs/ssmtp"
        - name: tz-config
          mountPath: /etc/localtime
          readOnly: true
      - service:
          type: NodePort
      - ingress:
          enabled: true
          hosts:
            - transmission.{{ requiredEnv "MASTER_NODE_NAME" }}
          tls:
            - hosts:
                - transmission.{{ requiredEnv "MASTER_NODE_NAME" }}
              secretName: transmission-k8s-cert
          annotations:
            kubernetes.io/ingress.class: "nginx"
            certmanager.k8s.io/cluster-issuer: "ca-issuer"
            nginx.ingress.kubernetes.io/app-root: "/web/"
