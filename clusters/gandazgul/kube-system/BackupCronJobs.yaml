---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: incremental-backups
  namespace: default
spec:
  chart:
    spec:
      chart: cronjob
      version: ">=0.1.0"
      sourceRef:
        kind: HelmRepository
        name: gandazgul
        namespace: flux-system
  dependsOn:
    - name: main-volume
    - name: backup-volume
  interval: 1h0m0s
  values:
  # Twice a day at midnight and midday
    schedule: "0 0,12 * * *"
    image:
      repository: gandazgul/rdiff-backup
      tag: v7
      args:
      - /media/main
      - /media/backup
    volumes:
    - name: main-volume
      persistentVolumeClaim:
        claimName: main-volume
    - name: backup-volume
      persistentVolumeClaim:
        claimName: backup-volume
    volumeMounts:
    - name: main-volume
      mountPath: /media/main
    - name: backup-volume
      mountPath: /media/backup
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: clean-incremental-backups
  namespace: default
spec:
  chart:
    spec:
      chart: cronjob
      version: ">=0.1.0"
      sourceRef:
        kind: HelmRepository
        name: gandazgul
        namespace: flux-system
  interval: 1h0m0s
  values:
  # Every day at midnight
    schedule: "0 0 * * *"
    image:
      repository: gandazgul/rdiff-backup
      tag: v7
      args:
      - --remove-older-than
      - 4W
      - --force
      - /media/backup
    volumes:
    - name: main-volume
      persistentVolumeClaim:
        claimName: main-volume
    - name: backup-volume
      persistentVolumeClaim:
        claimName: backup-volume
    volumeMounts:
    - name: main-volume
      mountPath: /media/main
    - name: backup-volume
      mountPath: /media/backup

